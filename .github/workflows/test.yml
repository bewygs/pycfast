# Compatibility matrix — CFAST × GCC × Ubuntu
#
# Job count: 6 cfast-versions × 5 gcc-versions = 30 jobs
#
# cfast-version and gcc-version are both real matrix axes, producing a
# proper 6×5 cartesian product. The cfast-tag (inconsistent upstream naming)
# is resolved at runtime in the "Resolve CFAST tag" step.
#
# CFAST Git tags — upstream inconsistency
#   7.7.5 → CFAST-7.7.5   (with hyphen)
#   7.7.4 → CFAST7.7.4    (no hyphen)
#   7.7.3 → CFAST7.7.3
#   7.7.2 → CFAST7.7.2
#   7.7.1 → CFAST7.7.1
#   7.7.0 → CFAST7.7.0
#
# Hang detection
#   The hang occurs in generate_verif_data.py, not in pytest.
#   `timeout --kill-after=10 120` wraps that step to fail fast instead
#   of stalling the runner for 6 hours.

name: Compatibility Matrix

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/test.yml'

jobs:
  test:
    name: "cfast=${{ matrix.cfast-version }} | gcc=${{ matrix.gcc-version }}"
    runs-on: ubuntu-latest
    continue-on-error: true

    strategy:
      fail-fast: false
      matrix:
        cfast-version: ["7.7.0", "7.7.1", "7.7.2", "7.7.3", "7.7.4", "7.7.5"]
        gcc-version:   ["11", "12", "13", "14", "15"]

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Resolve the correct Git tag for this cfast-version.
      # 7.7.5 uses a hyphen (CFAST-7.7.5), all others do not (CFAST7.7.x).
      # The resolved tag is written to $GITHUB_ENV so all subsequent steps
      # can reference it as ${{ env.CFAST_TAG }}.
      # -----------------------------------------------------------------------
      - name: Resolve CFAST tag
        shell: bash
        run: |
          VERSION="${{ matrix.cfast-version }}"
          if [ "$VERSION" = "7.7.5" ]; then
            echo "CFAST_TAG=CFAST-${VERSION}" >> "$GITHUB_ENV"
          else
            echo "CFAST_TAG=CFAST${VERSION}" >> "$GITHUB_ENV"
          fi

      # -----------------------------------------------------------------------
      # Python + dependencies
      # -----------------------------------------------------------------------
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Install Python dependencies
        run: uv sync --extra dev

      # -----------------------------------------------------------------------
      # CFAST binary cache
      # -----------------------------------------------------------------------
      - name: Cache CFAST binary
        id: cache-cfast
        uses: actions/cache@v4
        with:
          path: ~/cfast-cache/cfast-${{ matrix.cfast-version }}-gcc${{ matrix.gcc-version }}
          key: cfast-${{ matrix.cfast-version }}-${{ runner.os }}-${{ runner.arch }}-gcc${{ matrix.gcc-version }}-${{ hashFiles('.github/workflows/test.yml') }}

      # -----------------------------------------------------------------------
      # Fortran compiler (only on cache miss)
      # -----------------------------------------------------------------------
      - name: Install GCC ${{ matrix.gcc-version }}
        if: steps.cache-cfast.outputs.cache-hit != 'true'
        uses: fortran-lang/setup-fortran@v1
        with:
          compiler: gcc
          version: ${{ matrix.gcc-version }}

      # -----------------------------------------------------------------------
      # Build CFAST
      # -----------------------------------------------------------------------
      - name: Clone and build CFAST ${{ matrix.cfast-version }}
        if: steps.cache-cfast.outputs.cache-hit != 'true'
        shell: bash
        run: |
          git clone --depth 1 --branch ${{ env.CFAST_TAG }} \
            https://github.com/firemodels/cfast.git \
            cfast-src
          cd cfast-src/Build/CFAST/gnu_linux_64
          chmod +x make_cfast.sh
          ./make_cfast.sh
          mkdir -p ~/cfast-cache
          cp cfast7_linux_64 \
            ~/cfast-cache/cfast-${{ matrix.cfast-version }}-gcc${{ matrix.gcc-version }}
          chmod +x \
            ~/cfast-cache/cfast-${{ matrix.cfast-version }}-gcc${{ matrix.gcc-version }}

      # -----------------------------------------------------------------------
      # Install binary to PATH
      # -----------------------------------------------------------------------
      - name: Install CFAST to PATH
        run: |
          sudo cp \
            ~/cfast-cache/cfast-${{ matrix.cfast-version }}-gcc${{ matrix.gcc-version }} \
            /usr/bin/cfast
          sudo chmod +x /usr/bin/cfast

      # -----------------------------------------------------------------------
      # Generate verification data
      # THIS is where hangs occur — wrapped with timeout.
      # SIGTERM after 120 s, SIGKILL after 130 s.
      # -----------------------------------------------------------------------
      - name: Generate verification data
        shell: bash
        run: |
          cd tests
          timeout --kill-after=10 120 python generate_verif_data.py --local

      # -----------------------------------------------------------------------
      # Run tests
      # --timeout=120 as a safety net for any hang inside pytest itself.
      # -----------------------------------------------------------------------
      - name: Run tests
        env:
          CFAST_VERSION: ${{ matrix.cfast-version }}
        run: |
          uv run pytest \
            --timeout=120 \
            --cov=src/pycfast \
            --cov-report=xml \
            --cov-report=term-missing
