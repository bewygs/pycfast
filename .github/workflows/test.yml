# Compatibility matrix + CI — unified workflow
#
# A single job covers all combinations of:
#   cfast-version × gcc-version × os × python-version
#
# The `continue-on-error: true` flag lets the full matrix run to completion
# so you can read the pass/fail table directly in the GitHub Actions summary
# via the job name:
#   "cfast=7.7.4 | gcc=13 | ubuntu-latest | py=3.12"
#
# Hang detection
# --------------
# CFAST compiled with certain gcc versions does not crash — it hangs silently.
# pytest-timeout (120 s per test) is used to detect and fail those cases.
# Add `--timeout=120` to your pytest call, and ensure pytest-timeout is listed
# in your dev dependencies (uv add --dev pytest-timeout).
#
# CFAST Git tags — upstream inconsistency
# ----------------------------------------
#   7.7.5 → CFAST-7.7.5   (with hyphen)
#   7.7.4 → CFAST7.7.4    (no hyphen)
#   7.7.3 → CFAST7.7.3
#   7.7.2 → CFAST7.7.2
#   7.7.1 → CFAST7.7.1    (inferred — verify if clone fails)
#   7.7.0 → CFAST7.7.0    (inferred — verify if clone fails)
# Each matrix entry carries its own `cfast-tag` field to handle this.
#
# Job count
# ---------
#   6 cfast-versions × 5 gcc-versions × 2 os = 60 compat cells
#   × 4 python-versions = 240 jobs total
# Python version only affects the pycfast layer, not the CFAST binary,
# so the CFAST binary is cached per (cfast-version, os, gcc-version) and
# shared across all 4 Python runs of the same cell.

name: Test

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/test.yml'

jobs:
  test:
    name: "cfast=${{ matrix.cfast-version }} | gcc=${{ matrix.gcc-version }} | ${{ matrix.os }} | py=${{ matrix.python-version }}"
    runs-on: ${{ matrix.os }}
    continue-on-error: true   # full matrix always completes; read results in summary

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        gcc-version: ['11', '12', '13', '14', '15']
        os: [ubuntu-latest, windows-latest]
        include:
          # ------------------------------------------------------------------
          # CFAST version metadata
          # Each entry adds cfast-version + cfast-tag.
          # OS-specific build paths are resolved in the per-os includes below.
          # ------------------------------------------------------------------

          # 7.7.5
          - cfast-version: "7.7.5"
            cfast-tag: "CFAST-7.7.5"
          # 7.7.4
          - cfast-version: "7.7.4"
            cfast-tag: "CFAST7.7.4"
          # 7.7.3
          - cfast-version: "7.7.3"
            cfast-tag: "CFAST7.7.3"
          # 7.7.2
          - cfast-version: "7.7.2"
            cfast-tag: "CFAST7.7.2"
          # 7.7.1
          - cfast-version: "7.7.1"
            cfast-tag: "CFAST7.7.1"
          # 7.7.0
          - cfast-version: "7.7.0"
            cfast-tag: "CFAST7.7.0"

          # ------------------------------------------------------------------
          # OS-specific build paths
          # ------------------------------------------------------------------
          - os: ubuntu-latest
            build-dir: gnu_linux_64
            build-script: make_cfast.sh
            binary-name: cfast7_linux_64
            cfast-install-path: /usr/bin/cfast

          - os: windows-latest
            build-dir: gnu_win_64
            build-script: make_cfast.bat
            binary-name: cfast7_win_64.exe
            cfast-install-path: C:\Windows\System32\cfast.exe

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Python + dependencies
      # -----------------------------------------------------------------------
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install Python dependencies
        run: uv sync --extra dev

      # -----------------------------------------------------------------------
      # CFAST binary cache
      # Key: (cfast-version, os, arch, gcc-version, workflow-file)
      # The binary does not depend on the Python version so it is shared
      # across all 4 Python runs of the same (cfast × gcc × os) cell.
      # -----------------------------------------------------------------------
      - name: Cache CFAST binary
        id: cache-cfast
        uses: actions/cache@v4
        with:
          path: ~/cfast-cache/cfast-${{ matrix.cfast-version }}-${{ matrix.os }}-gcc${{ matrix.gcc-version }}
          key: cfast-${{ matrix.cfast-version }}-${{ runner.os }}-${{ runner.arch }}-gcc${{ matrix.gcc-version }}-${{ hashFiles('.github/workflows/test.yml') }}

      # -----------------------------------------------------------------------
      # Fortran compiler (only needed on cache miss)
      # -----------------------------------------------------------------------
      - name: Install GCC ${{ matrix.gcc-version }}
        if: steps.cache-cfast.outputs.cache-hit != 'true'
        uses: fortran-lang/setup-fortran@v1
        with:
          compiler: gcc
          version: ${{ matrix.gcc-version }}

      - name: Install make (Windows)
        if: steps.cache-cfast.outputs.cache-hit != 'true' && runner.os == 'Windows'
        run: choco install make -y

      # -----------------------------------------------------------------------
      # Build CFAST — Linux
      # -----------------------------------------------------------------------
      - name: Clone and build CFAST ${{ matrix.cfast-version }} (Linux)
        if: steps.cache-cfast.outputs.cache-hit != 'true' && runner.os == 'Linux'
        shell: bash
        run: |
          git clone --depth 1 --branch ${{ matrix.cfast-tag }} \
            https://github.com/firemodels/cfast.git \
            cfast-src
          cd cfast-src/Build/CFAST/${{ matrix.build-dir }}
          chmod +x ${{ matrix.build-script }}
          ./${{ matrix.build-script }}
          mkdir -p ~/cfast-cache
          cp ${{ matrix.binary-name }} \
            ~/cfast-cache/cfast-${{ matrix.cfast-version }}-${{ matrix.os }}-gcc${{ matrix.gcc-version }}
          chmod +x \
            ~/cfast-cache/cfast-${{ matrix.cfast-version }}-${{ matrix.os }}-gcc${{ matrix.gcc-version }}

      # -----------------------------------------------------------------------
      # Build CFAST — Windows
      # -----------------------------------------------------------------------
      - name: Clone and build CFAST ${{ matrix.cfast-version }} (Windows)
        if: steps.cache-cfast.outputs.cache-hit != 'true' && runner.os == 'Windows'
        shell: cmd
        run: |
          git clone --depth 1 --branch ${{ matrix.cfast-tag }} ^
            https://github.com/firemodels/cfast.git ^
            cfast-src
          cd cfast-src\Build\CFAST\${{ matrix.build-dir }}
          call ${{ matrix.build-script }}
          if not exist "%USERPROFILE%\cfast-cache" mkdir "%USERPROFILE%\cfast-cache"
          copy ${{ matrix.binary-name }} ^
            "%USERPROFILE%\cfast-cache\cfast-${{ matrix.cfast-version }}-${{ matrix.os }}-gcc${{ matrix.gcc-version }}"

      # -----------------------------------------------------------------------
      # Install binary to system PATH
      # -----------------------------------------------------------------------
      - name: Install CFAST to PATH (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo cp \
            ~/cfast-cache/cfast-${{ matrix.cfast-version }}-${{ matrix.os }}-gcc${{ matrix.gcc-version }} \
            ${{ matrix.cfast-install-path }}
          sudo chmod +x ${{ matrix.cfast-install-path }}

      - name: Install CFAST to PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Copy-Item `
            "$env:USERPROFILE\cfast-cache\cfast-${{ matrix.cfast-version }}-${{ matrix.os }}-gcc${{ matrix.gcc-version }}" `
            "${{ matrix.cfast-install-path }}"

      - name: Verify CFAST on PATH
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            where cfast
          else
            which cfast
          fi

      # -----------------------------------------------------------------------
      # Tests
      # --timeout=120 kills any test where CFAST hangs silently.
      # A hang caused by an incompatible gcc/cfast combination will surface
      # as a FAILED (timeout) in the job summary instead of stalling forever.
      # -----------------------------------------------------------------------
      - name: Generate verification data
        shell: bash
        run: |
          cd tests
          python generate_verif_data.py --local

      - name: Run tests
        env:
          CFAST_VERSION: ${{ matrix.cfast-version }}
        run: |
          uv run pytest \
            --timeout=120 \
            --cov=src/pycfast \
            --cov-report=xml \
            --cov-report=term-missing

      # -----------------------------------------------------------------------
      # Codecov — only upload for the canonical combination to avoid noise:
      # latest CFAST + gcc 14 + ubuntu + python 3.12
      # -----------------------------------------------------------------------
      - name: Upload results to Codecov
        if: |
          matrix.cfast-version == '7.7.5' &&
          matrix.gcc-version == '14' &&
          matrix.os == 'ubuntu-latest' &&
          matrix.python-version == '3.12'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: cfast-${{ matrix.cfast-version }}-py${{ matrix.python-version }}-${{ matrix.os }}
          fail_ci_if_error: false