# Compatibility matrix — CFAST × GCC × Ubuntu
#
# Tests all combinations of cfast-version × gcc-version on ubuntu-latest
# with Python 3.11 fixed (Python version is irrelevant to the hang issue).
#
# Job count: 6 cfast-versions × 5 gcc-versions = 30 jobs
#
# Hang detection
# --------------
# The hang occurs during `generate_verif_data.py`, not in pytest itself.
# A 120 s `timeout` command wraps that step so a hanging CFAST binary
# causes a clear step failure instead of stalling the runner for 6 hours.
#
# Reading results
# ---------------
# Job names follow the pattern:
#   "cfast=7.7.4 | gcc=13"
# so the full pass/fail compatibility table is readable directly in the
# GitHub Actions summary without any external tooling.
#
# CFAST Git tags — upstream inconsistency
# ----------------------------------------
#   7.7.5 → CFAST-7.7.5   (with hyphen)
#   7.7.4 → CFAST7.7.4    (no hyphen)
#   7.7.3 → CFAST7.7.3
#   7.7.2 → CFAST7.7.2
#   7.7.1 → CFAST7.7.1    (inferred — verify if clone fails)
#   7.7.0 → CFAST7.7.0    (inferred — verify if clone fails)

name: Compatibility Matrix

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/test.yml'

jobs:
  test:
    name: "cfast=${{ matrix.cfast-version }} | gcc=${{ matrix.gcc-version }}"
    runs-on: ubuntu-latest
    continue-on-error: true  # all 30 cells always complete; read pass/fail in summary

    strategy:
      fail-fast: false
      matrix:
        gcc-version: ['11', '12', '13', '14', '15']
        include:
          # ------------------------------------------------------------------
          # Each cfast-version is a fully explicit entry to work around the
          # GitHub Actions limitation that `include` does not produce a
          # cartesian product with existing axes.
          # The gcc-version axis is the real matrix dimension; cfast-version
          # is added by repeating the include block for each gcc value.
          # ------------------------------------------------------------------
          - { gcc-version: '11', cfast-version: "7.7.5", cfast-tag: "CFAST-7.7.5" }
          - { gcc-version: '11', cfast-version: "7.7.4", cfast-tag: "CFAST7.7.4"  }
          - { gcc-version: '11', cfast-version: "7.7.3", cfast-tag: "CFAST7.7.3"  }
          - { gcc-version: '11', cfast-version: "7.7.2", cfast-tag: "CFAST7.7.2"  }
          - { gcc-version: '11', cfast-version: "7.7.1", cfast-tag: "CFAST7.7.1"  }
          - { gcc-version: '11', cfast-version: "7.7.0", cfast-tag: "CFAST7.7.0"  }

          - { gcc-version: '12', cfast-version: "7.7.5", cfast-tag: "CFAST-7.7.5" }
          - { gcc-version: '12', cfast-version: "7.7.4", cfast-tag: "CFAST7.7.4"  }
          - { gcc-version: '12', cfast-version: "7.7.3", cfast-tag: "CFAST7.7.3"  }
          - { gcc-version: '12', cfast-version: "7.7.2", cfast-tag: "CFAST7.7.2"  }
          - { gcc-version: '12', cfast-version: "7.7.1", cfast-tag: "CFAST7.7.1"  }
          - { gcc-version: '12', cfast-version: "7.7.0", cfast-tag: "CFAST7.7.0"  }

          - { gcc-version: '13', cfast-version: "7.7.5", cfast-tag: "CFAST-7.7.5" }
          - { gcc-version: '13', cfast-version: "7.7.4", cfast-tag: "CFAST7.7.4"  }
          - { gcc-version: '13', cfast-version: "7.7.3", cfast-tag: "CFAST7.7.3"  }
          - { gcc-version: '13', cfast-version: "7.7.2", cfast-tag: "CFAST7.7.2"  }
          - { gcc-version: '13', cfast-version: "7.7.1", cfast-tag: "CFAST7.7.1"  }
          - { gcc-version: '13', cfast-version: "7.7.0", cfast-tag: "CFAST7.7.0"  }

          - { gcc-version: '14', cfast-version: "7.7.5", cfast-tag: "CFAST-7.7.5" }
          - { gcc-version: '14', cfast-version: "7.7.4", cfast-tag: "CFAST7.7.4"  }
          - { gcc-version: '14', cfast-version: "7.7.3", cfast-tag: "CFAST7.7.3"  }
          - { gcc-version: '14', cfast-version: "7.7.2", cfast-tag: "CFAST7.7.2"  }
          - { gcc-version: '14', cfast-version: "7.7.1", cfast-tag: "CFAST7.7.1"  }
          - { gcc-version: '14', cfast-version: "7.7.0", cfast-tag: "CFAST7.7.0"  }

          - { gcc-version: '15', cfast-version: "7.7.5", cfast-tag: "CFAST-7.7.5" }
          - { gcc-version: '15', cfast-version: "7.7.4", cfast-tag: "CFAST7.7.4"  }
          - { gcc-version: '15', cfast-version: "7.7.3", cfast-tag: "CFAST7.7.3"  }
          - { gcc-version: '15', cfast-version: "7.7.2", cfast-tag: "CFAST7.7.2"  }
          - { gcc-version: '15', cfast-version: "7.7.1", cfast-tag: "CFAST7.7.1"  }
          - { gcc-version: '15', cfast-version: "7.7.0", cfast-tag: "CFAST7.7.0"  }

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Python + dependencies
      # -----------------------------------------------------------------------
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Install Python dependencies
        run: uv sync --extra dev

      # -----------------------------------------------------------------------
      # CFAST binary cache
      # Keyed on (cfast-version, gcc-version, workflow-file).
      # Shared across re-runs as long as the workflow file is unchanged.
      # -----------------------------------------------------------------------
      - name: Cache CFAST binary
        id: cache-cfast
        uses: actions/cache@v4
        with:
          path: ~/cfast-cache/cfast-${{ matrix.cfast-version }}-gcc${{ matrix.gcc-version }}
          key: cfast-${{ matrix.cfast-version }}-${{ runner.os }}-${{ runner.arch }}-gcc${{ matrix.gcc-version }}-${{ hashFiles('.github/workflows/test.yml') }}

      # -----------------------------------------------------------------------
      # Fortran compiler (only on cache miss)
      # -----------------------------------------------------------------------
      - name: Install GCC ${{ matrix.gcc-version }}
        if: steps.cache-cfast.outputs.cache-hit != 'true'
        uses: fortran-lang/setup-fortran@v1
        with:
          compiler: gcc
          version: ${{ matrix.gcc-version }}

      # -----------------------------------------------------------------------
      # Build CFAST
      # -----------------------------------------------------------------------
      - name: Clone and build CFAST ${{ matrix.cfast-version }}
        if: steps.cache-cfast.outputs.cache-hit != 'true'
        shell: bash
        run: |
          git clone --depth 1 --branch ${{ matrix.cfast-tag }} \
            https://github.com/firemodels/cfast.git \
            cfast-src
          cd cfast-src/Build/CFAST/gnu_linux_64
          chmod +x make_cfast.sh
          ./make_cfast.sh
          mkdir -p ~/cfast-cache
          cp cfast7_linux_64 \
            ~/cfast-cache/cfast-${{ matrix.cfast-version }}-gcc${{ matrix.gcc-version }}
          chmod +x \
            ~/cfast-cache/cfast-${{ matrix.cfast-version }}-gcc${{ matrix.gcc-version }}

      # -----------------------------------------------------------------------
      # Install binary to PATH
      # -----------------------------------------------------------------------
      - name: Install CFAST to PATH
        run: |
          sudo cp \
            ~/cfast-cache/cfast-${{ matrix.cfast-version }}-gcc${{ matrix.gcc-version }} \
            /usr/bin/cfast
          sudo chmod +x /usr/bin/cfast

      # -----------------------------------------------------------------------
      # Generate verification data — THIS is where hangs occur.
      # `timeout 120` sends SIGTERM after 120 s and SIGKILL after 130 s,
      # making the step fail immediately instead of stalling the runner.
      # -----------------------------------------------------------------------
      - name: Generate verification data
        shell: bash
        run: |
          cd tests
          timeout --kill-after=10 900 python generate_verif_data.py --local

      # -----------------------------------------------------------------------
      # Run tests (only reached if verification data was generated successfully)
      # --timeout=120 as a second safety net for any hanging pytest call.
      # -----------------------------------------------------------------------
      - name: Run tests
        env:
          CFAST_VERSION: ${{ matrix.cfast-version }}
        run: |
          uv run pytest \
            --timeout=120 \
            --cov=src/pycfast \
            --cov-report=xml \
            --cov-report=term-missing
