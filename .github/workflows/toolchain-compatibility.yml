# This workflow tests CFAST compilation and runtime across multiple CFAST versions and compiler toolchains
# Supported compilers: GCC (gfortran), Intel ifx (LLVM-based), Intel ifort (classic)
# It helps identify compatibility issues between CFAST versions and compiler versions
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Toolchain Compatibility Test

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/toolchain-compatibility.yml'

  pull_request:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/toolchain-compatibility.yml'

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        cfast-version: ["7.7.5", "7.7.4", "7.7.3", "7.7.2", "7.7.1", "7.7.0"]
        toolchain:
        # GCC / gfortran
        - {compiler: gcc, version: '11'}
        - {compiler: gcc, version: '12'}
        - {compiler: gcc, version: '13'}
        - {compiler: gcc, version: '14'}
        - {compiler: gcc, version: 'latest'}
        # Intel ifx (LLVM-based)
        - {compiler: intel, version: '2025.0'}
        - {compiler: intel, version: '2024.2'}
        - {compiler: intel, version: '2024.0'}
        - {compiler: intel, version: '2023.2'}
        - {compiler: intel, version: '2023.0'}
        # Intel ifort (classic)
        - {compiler: intel-classic, version: '2021.12'}
        - {compiler: intel-classic, version: '2021.11'}
        - {compiler: intel-classic, version: '2021.10'}
        - {compiler: intel-classic, version: '2021.9'}
        - {compiler: intel-classic, version: '2021.7'}

    steps:
    - uses: actions/checkout@v6

    - name: Set CFAST tag
      id: cfast-tag
      shell: bash
      run: |
        # 7.7.5 uses "CFAST-7.7.5", all others use "CFASTX.Y.Z" without dash
        if [ "${{ matrix.cfast-version }}" = "7.7.5" ]; then
          echo "tag=CFAST-7.7.5" >> $GITHUB_OUTPUT
        else
          echo "tag=CFAST${{ matrix.cfast-version }}" >> $GITHUB_OUTPUT
        fi

    - name: Set build configuration
      id: build-config
      shell: bash
      run: |
        COMPILER="${{ matrix.toolchain.compiler }}"
        if [ "$COMPILER" = "gcc" ]; then
          PREFIX="gnu"
        else
          PREFIX="intel"
        fi
        if [ "${{ runner.os }}" = "Windows" ]; then
          echo "build-dir=${PREFIX}_win_64" >> $GITHUB_OUTPUT
          echo "build-script=make_cfast.bat" >> $GITHUB_OUTPUT
          echo "binary-name=cfast7_win_64.exe" >> $GITHUB_OUTPUT
        else
          echo "build-dir=${PREFIX}_linux_64" >> $GITHUB_OUTPUT
          echo "build-script=make_cfast.sh" >> $GITHUB_OUTPUT
          echo "binary-name=cfast7_linux_64" >> $GITHUB_OUTPUT
        fi

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python 3.11
      run: uv python install 3.11

    - name: Cache CFAST binary
      id: cache-cfast
      uses: actions/cache@v4
      with:
        path: ~/cfast-cache/cfast-${{ matrix.cfast-version }}-${{ matrix.os }}-${{ matrix.toolchain.compiler }}-${{ matrix.toolchain.version }}
        key: cfast-binary-${{ matrix.cfast-version }}-${{ runner.os }}-${{ runner.arch }}-${{ matrix.toolchain.compiler }}-${{ matrix.toolchain.version }}-${{ hashFiles('.github/workflows/toolchain-compatibility.yml') }}
        restore-keys: |
          cfast-binary-${{ matrix.cfast-version }}-${{ runner.os }}-${{ runner.arch }}-${{ matrix.toolchain.compiler }}-${{ matrix.toolchain.version }}-

    - name: Install python dependencies
      run: uv sync --extra dev

    - name: Install build dependencies for CFAST
      if: steps.cache-cfast.outputs.cache-hit != 'true'
      uses: fortran-lang/setup-fortran@v1
      with:
        compiler: ${{ matrix.toolchain.compiler }}
        version: ${{ matrix.toolchain.version }}

    - name: Install make (Windows, gcc only)
      if: steps.cache-cfast.outputs.cache-hit != 'true' && runner.os == 'Windows' && matrix.toolchain.compiler == 'gcc'
      run: choco install make -y

    # --- Windows build ---
    - name: Download and build CFAST ${{ matrix.cfast-version }} (Windows)
      if: steps.cache-cfast.outputs.cache-hit != 'true' && runner.os == 'Windows'
      shell: cmd
      run: |
        git clone --depth 1 --branch ${{ steps.cfast-tag.outputs.tag }} https://github.com/firemodels/cfast.git cfast-${{ matrix.cfast-version }}
        cd cfast-${{ matrix.cfast-version }}\Build\CFAST\${{ steps.build-config.outputs.build-dir }}
        call ${{ steps.build-config.outputs.build-script }}
        if not exist "%USERPROFILE%\cfast-cache" mkdir "%USERPROFILE%\cfast-cache"
        copy ${{ steps.build-config.outputs.binary-name }} "%USERPROFILE%\cfast-cache\cfast-${{ matrix.cfast-version }}-${{ matrix.os }}-${{ matrix.toolchain.compiler }}-${{ matrix.toolchain.version }}"

    # --- Linux build ---
    - name: Download and build CFAST ${{ matrix.cfast-version }} (Linux)
      if: steps.cache-cfast.outputs.cache-hit != 'true' && runner.os == 'Linux'
      shell: bash
      run: |
        git clone --depth 1 --branch ${{ steps.cfast-tag.outputs.tag }} https://github.com/firemodels/cfast.git cfast-${{ matrix.cfast-version }}
        cd cfast-${{ matrix.cfast-version }}/Build/CFAST/${{ steps.build-config.outputs.build-dir }}
        chmod +x ${{ steps.build-config.outputs.build-script }}
        ./${{ steps.build-config.outputs.build-script }}
        mkdir -p ~/cfast-cache
        cp ${{ steps.build-config.outputs.binary-name }} ~/cfast-cache/cfast-${{ matrix.cfast-version }}-${{ matrix.os }}-${{ matrix.toolchain.compiler }}-${{ matrix.toolchain.version }}
        chmod +x ~/cfast-cache/cfast-${{ matrix.cfast-version }}-${{ matrix.os }}-${{ matrix.toolchain.compiler }}-${{ matrix.toolchain.version }}

    - name: Install CFAST to system path (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo cp ~/cfast-cache/cfast-${{ matrix.cfast-version }}-${{ matrix.os }}-${{ matrix.toolchain.compiler }}-${{ matrix.toolchain.version }} /usr/bin/cfast
        sudo chmod +x /usr/bin/cfast

    - name: Install CFAST to system path (Windows)
      if: runner.os == 'Windows'
      run: |
        copy "$env:USERPROFILE\cfast-cache\cfast-${{ matrix.cfast-version }}-${{ matrix.os }}-${{ matrix.toolchain.compiler }}-${{ matrix.toolchain.version }}" "C:\Windows\System32\cfast.exe"

    - name: Verify CFAST installation
      shell: bash
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          where cfast
        else
          which cfast
        fi
        cfast

    - name: Run CFAST verification data generation (checks that CFAST can be executed and generates output)
      id: verif
      shell: bash
      run: |
        cd tests
        set +e
        timeout 10m python generate_verif_data.py --local
        EXIT_CODE=$?
        cd ..
        mkdir -p compatibility-results
        if [ $EXIT_CODE -eq 0 ]; then
          RESULT="success"
        elif [ $EXIT_CODE -eq 124 ]; then
          RESULT="timeout"
        else
          RESULT="error"
        fi
        echo "{\"os\":\"${{ matrix.os }}\",\"cfast\":\"${{ matrix.cfast-version }}\",\"compiler\":\"${{ matrix.toolchain.compiler }}\",\"compiler_version\":\"${{ matrix.toolchain.version }}\",\"result\":\"${RESULT}\",\"exit_code\":${EXIT_CODE}}" \
          > compatibility-results/compat-${{ matrix.os }}-cfast${{ matrix.cfast-version }}-${{ matrix.toolchain.compiler }}-${{ matrix.toolchain.version }}.json
        # Fail the step if verification failed so the job status reflects reality
        exit $EXIT_CODE

    - name: Upload compatibility result
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: compat-${{ matrix.os }}-cfast${{ matrix.cfast-version }}-${{ matrix.toolchain.compiler }}-${{ matrix.toolchain.version }}
        path: compatibility-results/*.json
        retention-days: 5

  summary:
    name: Compatibility Matrix Summary
    needs: test
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Download all results
      uses: actions/download-artifact@v4
      with:
        pattern: compat-*
        merge-multiple: true
        path: results

    - name: Generate compatibility matrix
      shell: python3 {0}
      run: |
        import json
        import os
        from pathlib import Path

        COMPILER_LABELS = {
            "gcc": "gcc (gfortran)",
            "intel": "intel (ifx)",
            "intel-classic": "intel-classic (ifort)",
        }

        def version_sort_key(v):
            """Sort versions numerically, with 'latest' always last."""
            if v == "latest":
                return (1, [])
            try:
                return (0, list(map(int, v.split("."))))
            except ValueError:
                return (0, [v])

        results = {}
        results_dir = Path("results")

        if results_dir.exists():
            for f in results_dir.glob("*.json"):
                try:
                    data = json.loads(f.read_text())
                    key = (data["os"], data["cfast"], data["compiler"], data["compiler_version"])
                    results[key] = data
                except (json.JSONDecodeError, KeyError) as e:
                    print(f"Warning: could not parse {f}: {e}")

        os_list = sorted(set(k[0] for k in results))
        cfast_versions = sorted(
            set(k[1] for k in results),
            key=lambda v: list(map(int, v.split("."))),
            reverse=True,
        )
        compilers = sorted(set(k[2] for k in results), key=lambda c: list(COMPILER_LABELS.keys()).index(c) if c in COMPILER_LABELS else 99)

        STATUS_MAP = {
            "success": "‚úÖ",
            "timeout": "‚è±Ô∏è",
            "error": "‚ùå",
        }

        summary = "# Toolchain Compatibility Matrix\n\n"

        for os_name in os_list:
            summary += f"## {os_name}\n\n"

            for compiler in compilers:
                label = COMPILER_LABELS.get(compiler, compiler)
                versions = sorted(
                    set(k[3] for k in results if k[0] == os_name and k[2] == compiler),
                    key=version_sort_key,
                )
                if not versions:
                    continue

                summary += f"### {label}\n\n"
                summary += "| CFAST \\\\ Version | " + " | ".join(f"`{v}`" for v in versions) + " |\n"
                summary += "|---" + "|---" * len(versions) + "|\n"

                for cv in cfast_versions:
                    row = f"| **{cv}** |"
                    for ver in versions:
                        key = (os_name, cv, compiler, ver)
                        if key in results:
                            status = results[key]["result"]
                            exit_code = results[key].get("exit_code", "?")
                            icon = STATUS_MAP.get(status, "‚ùì")
                            if status == "error":
                                row += f" {icon} `exit {exit_code}` |"
                            else:
                                row += f" {icon} |"
                        else:
                            row += " üîß |"
                    row += "\n"
                    summary += row

                summary += "\n"

        # Stats
        total = len(results)
        successes = sum(1 for r in results.values() if r["result"] == "success")
        timeouts = sum(1 for r in results.values() if r["result"] == "timeout")
        errors = sum(1 for r in results.values() if r["result"] == "error")
        build_failures = 0
        for os_name in os_list:
            for cv in cfast_versions:
                for compiler in compilers:
                    versions = set(k[3] for k in results if k[0] == os_name and k[2] == compiler)
                    for ver in versions:
                        if (os_name, cv, compiler, ver) not in results:
                            build_failures += 1

        summary += "### Legend\n\n"
        summary += "| Symbol | Meaning |\n"
        summary += "|---|---|\n"
        summary += "| ‚úÖ | Success |\n"
        summary += "| ‚è±Ô∏è | Timeout (>60 min) |\n"
        summary += "| ‚ùå | Runtime error (with exit code) |\n"
        summary += "| üîß | Build failure (no result produced) |\n"
        summary += "\n"
        summary += f"### Summary: {successes}/{total} passed"
        if timeouts:
            summary += f", {timeouts} timeouts"
        if errors:
            summary += f", {errors} errors"
        if build_failures:
            summary += f", {build_failures} build failures"
        summary += "\n"

        with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
            f.write(summary)

        print(summary)
